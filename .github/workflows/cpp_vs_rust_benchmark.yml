name: C++ Limcode vs Rust Wincode Benchmark

on:
  push:
    branches: [master]
    paths:
      - 'include/limcode/**'
      - 'benchmark/**'
      - 'CMakeLists.txt'
      - '.github/workflows/cpp_vs_rust_benchmark.yml'
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  cpp-vs-rust-benchmark:
    name: C++ vs Rust Performance Comparison
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            g++-13 \
            libnuma-dev \
            cpufrequtils \
            linux-tools-common \
            linux-tools-generic

          # Set g++-13 as default
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-cpp-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Get system information
        id: sysinfo
        run: |
          echo "=== System Information ===" | tee /tmp/sysinfo.txt
          echo "" | tee -a /tmp/sysinfo.txt

          # CPU info
          CPU_MODEL=$(lscpu | grep "Model name" | sed 's/Model name://g' | xargs)
          CPU_CORES=$(nproc)
          CPU_FLAGS=$(lscpu | grep "Flags" | sed 's/Flags://g' | xargs)

          echo "CPU: $CPU_MODEL" | tee -a /tmp/sysinfo.txt
          echo "Cores: $CPU_CORES" | tee -a /tmp/sysinfo.txt
          echo "" | tee -a /tmp/sysinfo.txt

          # Check SIMD support
          echo "SIMD Features:" | tee -a /tmp/sysinfo.txt
          grep -o 'avx[^ ]*\|sse[^ ]*' /proc/cpuinfo | sort -u | tee -a /tmp/sysinfo.txt
          echo "" | tee -a /tmp/sysinfo.txt

          # Memory info
          MEM_TOTAL=$(free -h | awk '/^Mem:/ {print $2}')
          echo "Memory: $MEM_TOTAL" | tee -a /tmp/sysinfo.txt
          echo "" | tee -a /tmp/sysinfo.txt

          # Timestamp
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          echo "Timestamp: $TIMESTAMP" | tee -a /tmp/sysinfo.txt

          # Set outputs
          echo "cpu_model=$CPU_MODEL" >> $GITHUB_OUTPUT
          echo "cpu_cores=$CPU_CORES" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Build C++ benchmarks
        run: |
          echo "Building C++ limcode with ultra-aggressive optimizations..."
          mkdir -p build_cpp
          cd build_cpp

          # CMake will use -march=x86-64-v2 for CI (see CMakeLists.txt)
          cmake .. -DCMAKE_BUILD_TYPE=Release -DENABLE_HYPER_OPTIMIZATION=ON

          # Build table_bench for README table generation
          make table_bench -j$(nproc)

          echo ""
          echo "C++ build complete!"
          ls -lh table_bench

      - name: Build Rust benchmarks
        run: |
          echo "Building Rust benchmarks..."
          cargo build --release --example benchmark_large_blocks

          echo ""
          echo "Rust build complete!"
          ls -lh target/release/examples/benchmark_large_blocks

      - name: Run C++ benchmark
        id: cpp_bench
        run: |
          echo "=== C++ Limcode Table Benchmark ===" | tee /tmp/cpp_results.txt
          echo "" | tee -a /tmp/cpp_results.txt

          cd build_cpp
          timeout 300 ./table_bench 2>&1 | tee -a /tmp/cpp_results.txt || true

          echo "" | tee -a /tmp/cpp_results.txt
          cat /tmp/cpp_results.txt

      - name: Run Rust benchmark
        id: rust_bench
        run: |
          echo "=== Rust Wincode/Bincode Benchmark ===" | tee /tmp/rust_results.txt
          echo "" | tee -a /tmp/rust_results.txt

          timeout 300 cargo run --release --example benchmark_large_blocks 2>&1 | tee -a /tmp/rust_results.txt || true

          echo "" | tee -a /tmp/rust_results.txt
          cat /tmp/rust_results.txt

      - name: Parse and merge benchmark results
        id: compare
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          # Read C++ results (CSV format: Size,Throughput_GBps)
          cpp_data = {}
          with open('/tmp/cpp_results.txt', 'r') as f:
              for line in f:
                  if ',' in line and line.strip() and not line.startswith('C++'):
                      parts = line.strip().split(',')
                      if len(parts) == 2:
                          size = parts[0]
                          try:
                              throughput = float(parts[1])
                              cpp_data[size] = throughput
                          except ValueError:
                              pass

          # Read Rust results
          with open('/tmp/rust_results.txt', 'r') as f:
              rust_output = f.read()

          # Extract Rust table data
          # Find the benchmark table in Rust output
          table_match = re.search(r'\| Size \| Limcode \| Wincode \| Bincode.*?\n\|.*?\n((?:\|.*?\n)+)', rust_output, re.DOTALL)

          rust_data = {}
          if table_match:
              table_lines = table_match.group(1).strip().split('\n')
              for line in table_lines:
                  parts = [p.strip() for p in line.split('|') if p.strip()]
                  if len(parts) >= 4:
                      size = parts[0]
                      try:
                          limcode = float(parts[1].replace(' GB/s', ''))
                          wincode = parts[2].replace(' GB/s', '')
                          bincode = float(parts[3].replace(' GB/s', ''))

                          if 'N/A' in wincode or 'limit' in wincode.lower():
                              wincode_val = None
                          else:
                              wincode_val = float(wincode)

                          rust_data[size] = {
                              'limcode': limcode,
                              'wincode': wincode_val,
                              'bincode': bincode
                          }
                      except (ValueError, IndexError):
                          pass

          # Generate combined table
          table_rows = []
          for size in ['64B', '128B', '256B', '512B', '1KB', '2KB', '4KB', '8KB', '16KB', '32KB', '64KB',
                       '128KB', '256KB', '512KB', '1MB', '2MB', '4MB', '8MB', '16MB', '32MB', '64MB', '128MB']:

              cpp_val = cpp_data.get(size)
              rust_vals = rust_data.get(size, {})

              if cpp_val is not None and rust_vals:
                  rust_limcode = rust_vals.get('limcode', 0)
                  rust_wincode = rust_vals.get('wincode')
                  rust_bincode = rust_vals.get('bincode', 0)

                  # Calculate speedups
                  cpp_vs_rust = (cpp_val / rust_limcode * 100 - 100) if rust_limcode > 0 else 0
                  rust_vs_wincode = (rust_limcode / rust_wincode * 100 - 100) if rust_wincode and rust_wincode > 0 else 0
                  rust_vs_bincode = (rust_limcode / rust_bincode * 100 - 100) if rust_bincode > 0 else 0

                  wincode_str = f"{rust_wincode:.2f} GB/s" if rust_wincode else "N/A (>4MB limit)"

                  row = f"| {size:6} | {cpp_val:10.2f} GB/s | {rust_limcode:10.2f} GB/s | {wincode_str:14} | {rust_bincode:10.2f} GB/s | {cpp_vs_rust:+8.1f}% | {rust_vs_wincode:+8.1f}% | {rust_vs_bincode:+8.1f}% |"
                  table_rows.append(row)

          # Create combined table
          combined_table = """| Size   | C++ Limcode    | Rust Limcode   | Wincode        | Bincode        | C++ vs Rust | Rust vs Wincode | Rust vs Bincode |
|--------|----------------|----------------|----------------|----------------|-------------|-----------------|-----------------|
""" + '\n'.join(table_rows)

          # Save combined table
          with open('/tmp/combined_table.txt', 'w') as f:
              f.write(combined_table)

          print("Combined Benchmark Table:")
          print(combined_table)

          # Calculate summary stats
          cpp_peak = max(cpp_data.values()) if cpp_data else 0
          rust_limcode_peak = max([v['limcode'] for v in rust_data.values()]) if rust_data else 0

          # Save outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"cpp_peak={cpp_peak:.2f}\n")
              f.write(f"rust_peak={rust_limcode_peak:.2f}\n")
              f.write(f"cpp_speedup={cpp_peak / rust_limcode_peak if rust_limcode_peak > 0 else 0:.2f}\n")

          PYTHON_SCRIPT
        env:
          CPU_MODEL: ${{ steps.sysinfo.outputs.cpu_model }}
          CPU_CORES: ${{ steps.sysinfo.outputs.cpu_cores }}
          TIMESTAMP: ${{ steps.sysinfo.outputs.timestamp }}

      - name: Update README with combined table
        env:
          TIMESTAMP: ${{ steps.sysinfo.outputs.timestamp }}
          CPU_INFO: ${{ steps.sysinfo.outputs.cpu_model }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          # Read combined table
          with open('/tmp/combined_table.txt', 'r') as f:
              combined_table = f.read().strip()

          # Read current README
          with open('README.md', 'r') as f:
              readme = f.read()

          # Get metadata
          timestamp = os.environ.get('TIMESTAMP', 'Unknown')
          cpu_info = os.environ.get('CPU_INFO', 'Unknown')

          # Find and replace the throughput analysis section
          # Match from "### Throughput Analysis" to "*Key Results:**"
          pattern = r'(### Throughput Analysis.*?\n\n.*?\n\n)(\| Size.*?\n\|.*?\n)(.*?)(\n\*\*Key Results:\*\*)'

          def replacement(match):
              header = match.group(1)
              # Replace table with combined table
              new_content = combined_table + f'\n\n*ðŸ“Š Benchmarked: {timestamp}*  \n*ðŸ’» CPU: {cpu_info}*  \n*ðŸ¤– Runner: GitHub Actions (ubuntu-latest)*'
              key_results = match.group(4)
              return header + new_content + key_results

          if re.search(pattern, readme, re.DOTALL):
              new_readme = re.sub(pattern, replacement, readme, flags=re.DOTALL)

              with open('README.md', 'w') as f:
                  f.write(new_readme)

              print("âœ… README updated with C++ + Rust combined table")
              print(f"Timestamp: {timestamp}")
              print(f"CPU: {cpu_info}")
          else:
              print("âš ï¸ Could not find throughput analysis section in README")
              print("README will not be updated")
          PYTHON_SCRIPT

      - name: Check if README changed
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in README.md"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in README.md:"
            git diff README.md | head -50
          fi

      - name: Commit and push updated README
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "$(cat <<'EOF'
          benchmark: Update README with C++ + Rust comparison

          Combined benchmark table with C++ Limcode, Rust Limcode, Wincode, and Bincode.

          C++ Peak: ${{ steps.compare.outputs.cpp_peak }} GB/s
          Rust Peak: ${{ steps.compare.outputs.rust_peak }} GB/s
          Speedup: ${{ steps.compare.outputs.cpp_speedup }}x

          Runner: ubuntu-latest
          CPU: ${{ steps.sysinfo.outputs.cpu_info }}
          Timestamp: ${{ steps.sysinfo.outputs.timestamp }}

          ðŸ¤– Automated by GitHub Actions
          EOF
          )"
          git push

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-vs-rust-benchmark-results
          path: |
            /tmp/cpp_results.txt
            /tmp/rust_results.txt
            /tmp/combined_table.txt
            /tmp/sysinfo.txt
          retention-days: 90

      - name: Post results summary
        run: |
          echo "## ðŸš€ C++ + Rust Combined Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Combined Performance Table" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/combined_table.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**C++ Peak**: ${{ steps.compare.outputs.cpp_peak }} GB/s" >> $GITHUB_STEP_SUMMARY
          echo "**Rust Peak**: ${{ steps.compare.outputs.rust_peak }} GB/s" >> $GITHUB_STEP_SUMMARY
          echo "**C++ Speedup**: ${{ steps.compare.outputs.cpp_speedup }}x faster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CPU**: ${{ steps.sysinfo.outputs.cpu_info }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: ${{ steps.sysinfo.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… README.md updated with combined table" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to README.md" >> $GITHUB_STEP_SUMMARY
          fi
